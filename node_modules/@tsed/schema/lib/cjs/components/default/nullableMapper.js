"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.nullableMapper = void 0;
const core_1 = require("@tsed/core");
const jsonSchemaProperties_js_1 = require("../../constants/jsonSchemaProperties.js");
const JsonSchemaMapperContainer_js_1 = require("../../registries/JsonSchemaMapperContainer.js");
function nullableMapper(obj, schema) {
    if (!schema?.isNullable) {
        return obj;
    }
    if (!obj.discriminator) {
        if (obj.$ref) {
            obj = (0, core_1.cleanObject)({
                ...obj,
                $ref: undefined,
                anyOf: [
                    { type: "null" },
                    {
                        $ref: obj.$ref
                    }
                ]
            });
        }
        else {
            jsonSchemaProperties_js_1.MANY_OF_PROPERTIES.some((keyword) => {
                if (obj[keyword]) {
                    obj[keyword] = obj[keyword].filter((item) => item.type !== "null");
                    if (obj[keyword].length === 1) {
                        const base = obj[keyword];
                        obj = (0, core_1.cleanObject)({
                            ...obj,
                            ...base[0],
                            [keyword]: undefined,
                            type: ["null", Number.isInteger(obj.multipleOf) ? "integer" : base[0].type]
                        });
                    }
                    else {
                        obj[keyword] = [{ type: "null" }].concat(obj[keyword]).map((item) => {
                            if (Number.isInteger(item.multipleOf)) {
                                item.type = "integer";
                            }
                            return item;
                        });
                        delete obj.type;
                    }
                }
            });
        }
    }
    return obj;
}
exports.nullableMapper = nullableMapper;
(0, JsonSchemaMapperContainer_js_1.registerJsonSchemaMapper)("nullable", nullableMapper);
//# sourceMappingURL=nullableMapper.js.map