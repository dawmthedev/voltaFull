"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.inheritedClassMapper = void 0;
const core_1 = require("@tsed/core");
const JsonSchemaMapperContainer_js_1 = require("../../registries/JsonSchemaMapperContainer.js");
const getInheritedStores_js_1 = require("../../utils/getInheritedStores.js");
function alterMerge(_, obj) {
    if (obj?.type && obj?.$ref) {
        const { $ref, ...schema } = obj;
        obj = {
            allOf: [
                {
                    $ref
                },
                schema
            ]
        };
    }
    return obj;
}
/**
 * @ignore
 */
function inheritedClassMapper(obj, { target, ...options }) {
    const stores = Array.from((0, getInheritedStores_js_1.getInheritedStores)(target).entries()).filter(([model]) => (0, core_1.classOf)(model) !== (0, core_1.classOf)(target));
    if (stores.length) {
        const schema = stores.reduce((obj, [, store]) => {
            return (0, core_1.deepMerge)(obj, (0, JsonSchemaMapperContainer_js_1.execMapper)("schema", [store.schema], options), { alter: alterMerge });
        }, {});
        return (0, core_1.deepMerge)(schema, obj, { alter: alterMerge });
    }
    return obj;
}
exports.inheritedClassMapper = inheritedClassMapper;
(0, JsonSchemaMapperContainer_js_1.registerJsonSchemaMapper)("inheritedClass", inheritedClassMapper);
//# sourceMappingURL=inheritedClassMapper.js.map