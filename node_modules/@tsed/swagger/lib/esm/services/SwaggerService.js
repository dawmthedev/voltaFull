import { __decorate, __metadata, __param } from "tslib";
import { Configuration, Injectable, InjectorService, Platform } from "@tsed/common";
import { generateSpec } from "@tsed/schema";
import { includeRoute } from "../utils/includeRoute.js";
import { readSpec } from "../utils/readSpec.js";
let SwaggerService = class SwaggerService {
    #specs;
    constructor(injectorService, platform, configuration) {
        this.injectorService = injectorService;
        this.platform = platform;
        this.configuration = configuration;
        this.#specs = new Map();
    }
    async getOpenAPISpec(conf) {
        if (!this.#specs.has(conf.path)) {
            const { version = "1.0.0", acceptMimes } = this.configuration;
            const specPath = conf.specPath ? this.configuration.resolve(conf.specPath) : conf.specPath;
            const tokens = this.platform
                .getMountedControllers()
                .filter(({ routes, provider }) => [...routes.values()].some((route) => includeRoute(route, provider, conf)))
                .map(({ route, provider }) => ({ token: provider.token, rootPath: route }));
            let spec = generateSpec({
                tokens,
                ...conf,
                fileSpec: specPath ? await readSpec(specPath) : {},
                version,
                acceptMimes
            });
            spec = await this.injectorService.alterAsync("$alterOpenSpec", spec, conf);
            this.#specs.set(conf.path, spec);
        }
        return this.#specs.get(conf.path);
    }
};
SwaggerService = __decorate([
    Injectable(),
    __param(2, Configuration()),
    __metadata("design:paramtypes", [InjectorService,
        Platform, Object])
], SwaggerService);
export { SwaggerService };
//# sourceMappingURL=SwaggerService.js.map